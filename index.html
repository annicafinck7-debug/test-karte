<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Verkaufs-Karte Pro</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body{height:100%;margin:0;background:#0e1117;color:#fff;font-family:system-ui}
#map{height:100%;width:100%}

/* Topbar */
.topbar{
position:absolute;top:12px;left:12px;right:12px;
background:#161b22;padding:10px;border-radius:14px;
display:flex;gap:8px;align-items:center;z-index:3000
}
.topbar input,.topbar select{
background:#0e1117;border:1px solid #30363d;
color:#fff;padding:6px;border-radius:8px
}
.topbar button{
background:#238636;border:none;color:white;
padding:7px 10px;border-radius:8px;cursor:pointer
}

/* Results Panel */
.panel{
position:absolute;top:80px;right:12px;width:420px;
background:#161b22;border-radius:14px;
border:1px solid #30363d;
z-index:2000;overflow:hidden
}
.panel-header{
display:flex;justify-content:space-between;
padding:8px;background:#21262d;cursor:move
}
.panel-body{padding:10px;max-height:70vh;overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:6px;border-bottom:1px solid #30363d;font-size:13px}
tr:hover{background:#21262d;cursor:pointer}

.badge{
padding:3px 8px;border-radius:20px;font-size:12px
}
.good{background:#0f5132}
.mid{background:#664d03}
.bad{background:#842029}

/* Search dropdown */
.search-results{
position:absolute;top:55px;left:12px;
background:#161b22;border:1px solid #30363d;
border-radius:10px;z-index:5000;
max-height:250px;overflow:auto;width:250px
}
.search-results div{
padding:6px;border-bottom:1px solid #30363d;cursor:pointer
}
.search-results div:hover{background:#21262d}
</style>
</head>

<body>
<div id="map"></div>

<div class="topbar">
<input id="search" placeholder="Kunde suchen...">
<select id="product">
<option value="lose">Lose</option>
<option value="sackware">Sackware</option>
<option value="industrieware">Industrieware</option>
</select>
<input id="radius" type="number" value="250" placeholder="Radius km">
<input id="qty" type="number" value="24" placeholder="Menge t">
<input id="freight" type="number" value="1.85" step="0.01">
<input id="factor" type="number" value="1.05" step="0.01">
<input id="target" type="number" placeholder="Ziel VK">
<button onclick="calculate()">Berechnen</button>
<button onclick="geocodeAll()">Geocoden</button>
</div>

<div id="searchResults" class="search-results" style="display:none"></div>

<div class="panel">
<div class="panel-header">
<b>Top 5 Optionen</b>
</div>
<div class="panel-body">
<div id="results"></div>
</div>
</div>

<script>

/* ==============================
CONFIG
============================== */
const firmsUrl="https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/gviz/tq?tqx=out:csv&gid=0";
const customersUrl="https://docs.google.com/spreadsheets/d/1DaiLyZbhJkdSQ1PHbJQmguIrDnGrrhiAVgJC4PJO8vA/gviz/tq?tqx=out:csv&gid=0";

let map=L.map('map').setView([51.2,10.4],6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let customers=[],firms=[];
let selectedCustomer=null;
let routeLine=null;
let geoCache={};

/* ==============================
LOAD DATA
============================== */
function parseCSV(url){
return new Promise(resolve=>{
Papa.parse(url,{download:true,header:true,complete:r=>resolve(r.data)});
});
}

async function loadData(){
let c=await parseCSV(customersUrl);
customers=c.map((r,i)=>({
id:"C"+i,
name:r.name||r.Name||r.Kunde,
address:r.ort||r.Ort,
lat:null,lon:null
}));

let f=await parseCSV(firmsUrl);
firms=f.map((r,i)=>({
id:"F"+i,
name:r.firma||r.Firma,
address:r.ort||r.Ort,
base:{
lose:parseFloat(r.preis),
sackware:parseFloat(r.sackware),
industrieware:parseFloat(r.industriewar)
},
lat:null,lon:null
}));
}
loadData();

/* ==============================
GEOCODING
============================== */
async function geocodeAddress(address){
if(geoCache[address]) return geoCache[address];
let res=await fetch("https://nominatim.openstreetmap.org/search?format=json&limit=1&q="+encodeURIComponent(address));
let data=await res.json();
if(data[0]){
geoCache[address]={lat:parseFloat(data[0].lat),lon:parseFloat(data[0].lon)};
return geoCache[address];
}
return null;
}

async function geocodeAll(){
for(let c of customers){
if(!c.lat){
let g=await geocodeAddress(c.address);
if(g){c.lat=g.lat;c.lon=g.lon;
L.marker([c.lat,c.lon],{icon:emojiIcon("ðŸ§")})
.addTo(map).on("click",()=>selectCustomer(c));
}
await new Promise(r=>setTimeout(r,1000));
}
}
for(let f of firms){
if(!f.lat){
let g=await geocodeAddress(f.address);
if(g){f.lat=g.lat;f.lon=g.lon;
L.marker([f.lat,f.lon],{icon:emojiIcon("ðŸ­")})
.addTo(map)
.on("contextmenu",()=>editPrice(f));
}
await new Promise(r=>setTimeout(r,1000));
}
}
}

/* ==============================
EMOJI ICON
============================== */
function emojiIcon(emoji){
return L.divIcon({
html:`<div style="font-size:20px">${emoji}</div>`,
className:""
});
}

/* ==============================
SEARCH
============================== */
document.getElementById("search").addEventListener("input",function(){
let val=this.value.toLowerCase();
let box=document.getElementById("searchResults");
box.innerHTML="";
if(!val){box.style.display="none";return;}
let matches=customers.filter(c=>c.name && c.name.toLowerCase().includes(val));
matches.forEach(c=>{
let div=document.createElement("div");
div.innerText=c.name;
div.onclick=()=>{selectCustomer(c);box.style.display="none";};
box.appendChild(div);
});
box.style.display="block";
});

/* ==============================
SELECT CUSTOMER
============================== */
function selectCustomer(c){
selectedCustomer=c;
map.setView([c.lat,c.lon],8);
}

/* ==============================
ROUTING
============================== */
async function drawRoute(from,to){
if(routeLine) map.removeLayer(routeLine);
let url=`https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=full&geometries=geojson`;
let res=await fetch(url);
let data=await res.json();
if(data.routes[0]){
routeLine=L.geoJSON(data.routes[0].geometry,{color:"cyan"}).addTo(map);
map.fitBounds(routeLine.getBounds());
}
}

/* ==============================
CALCULATION (Pellet Formel)
============================== */
function calculate(){
if(!selectedCustomer) return alert("Kunde wÃ¤hlen!");

let product=document.getElementById("product").value;
let radius=parseFloat(document.getElementById("radius").value);
let qty=parseFloat(document.getElementById("qty").value);
let freight=parseFloat(document.getElementById("freight").value);
let factor=parseFloat(document.getElementById("factor").value);
let target=parseFloat(document.getElementById("target").value);

let results=[];

firms.forEach(f=>{
if(!f.lat) return;
let km=getDistance(selectedCustomer,f);
if(km>radius) return;

let base=f.base[product];
if(!base) return;

let delivered=base+((km*freight)/qty)*factor;
let margin=target?target-delivered:null;

results.push({f,km,delivered,margin});
});

results.sort((a,b)=>a.delivered-b.delivered);
results=results.slice(0,5);

let html="<table><tr><th>Firma</th><th>KM</th><th>Preis</th><th>Marge</th></tr>";
results.forEach(r=>{
let badge="";
if(r.margin!==null){
if(r.margin>10) badge=`<span class="badge good">+${r.margin.toFixed(2)}</span>`;
else if(r.margin>=0) badge=`<span class="badge mid">${r.margin.toFixed(2)}</span>`;
else badge=`<span class="badge bad">${r.margin.toFixed(2)}</span>`;
}
html+=`<tr onclick='selectOption("${r.f.id}")'>
<td>${r.f.name}</td>
<td>${r.km.toFixed(0)}</td>
<td>${r.delivered.toFixed(2)}</td>
<td>${badge||"-"}</td></tr>`;
});
html+="</table>";
document.getElementById("results").innerHTML=html;
}

/* ==============================
SELECT OPTION
============================== */
function selectOption(id){
let firm=firms.find(f=>f.id===id);
drawRoute(selectedCustomer,firm);
}

/* ==============================
DISTANCE
============================== */
function getDistance(a,b){
let R=6371;
let dLat=(b.lat-a.lat)*Math.PI/180;
let dLon=(b.lon-a.lon)*Math.PI/180;
let lat1=a.lat*Math.PI/180;
let lat2=b.lat*Math.PI/180;
let x=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

/* ==============================
EDIT PRICE
============================== */
function editPrice(f){
let newPrice=prompt("Neuer Preis:");
if(newPrice) f.base.lose=parseFloat(newPrice);
}

</script>
</body>
</html>
