<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Verkaufs-Karte â€“ Kunden & Firmen</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      /* LIGHT UI */
      --ui-bg:#ffffff;
      --ui-text:#0f172a;
      --ui-muted:#475569;
      --ui-border:rgba(15,23,42,.12);
      --ui-soft:rgba(15,23,42,.05);
      --ui-soft2:rgba(15,23,42,.08);
      --ui-shadow:0 12px 34px rgba(2,6,23,.12);

      /* Inputs */
      --inp-bg:#ffffff;
      --inp-text:#0f172a;
      --inp-border:rgba(15,23,42,.18);
      --inp-ph:rgba(15,23,42,.45);
      --inp-focus:rgba(37,99,235,.45);

      /* Buttons */
      --btn-bg:rgba(15,23,42,.06);
      --btn-border:rgba(15,23,42,.14);
      --btn-text:#0f172a;

      --btn-primary:#22c55e;
      --btn-primary-text:#052e16;

      /* Customer triangle */
      --cust-tri:#4c1d95;

      /* Leaflet popup */
      --popup-bg:#ffffff;
      --popup-text:#0f172a;
      --popup-border:rgba(15,23,42,.12);

      /* KPI / Accents */
      --pill-bg:rgba(15,23,42,.05);
      --pill-border:rgba(15,23,42,.12);
      --good:#16a34a;
      --mid:#f59e0b;
      --bad:#dc2626;

      /* Map */
      --map-zoom-bg:#ffffff;
      --map-zoom-text:#0f172a;
      --map-zoom-border:rgba(15,23,42,.15);
    }

    /* Dark mode variables */
    body.dark{
      --ui-bg:#0b1220;
      --ui-text:#e5e7eb;
      --ui-muted:#a3adc2;
      --ui-border:rgba(148,163,184,.18);
      --ui-soft:rgba(148,163,184,.10);
      --ui-soft2:rgba(148,163,184,.14);
      --ui-shadow:0 12px 34px rgba(0,0,0,.35);

      --inp-bg:#0f172a;
      --inp-text:#e5e7eb;
      --inp-border:rgba(148,163,184,.22);
      --inp-ph:rgba(229,231,235,.55);
      --inp-focus:rgba(59,130,246,.55);

      --btn-bg:rgba(148,163,184,.10);
      --btn-border:rgba(148,163,184,.22);
      --btn-text:#e5e7eb;

      --btn-primary:#22c55e;
      --btn-primary-text:#052e16;

      --popup-bg:#0f172a;
      --popup-text:#e5e7eb;
      --popup-border:rgba(148,163,184,.22);

      --pill-bg:rgba(148,163,184,.10);
      --pill-border:rgba(148,163,184,.22);

      --map-zoom-bg:#0f172a;
      --map-zoom-text:#e5e7eb;
      --map-zoom-border:rgba(148,163,184,.22);
    }

    html,body{height:100%;margin:0;background:var(--ui-bg)}
    #map{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
    }

    /* Topbar bÃ¼ndig oben (kein Schlitz) */
    .topbar{
      position:fixed;
      top:0; left:0; right:0;
      z-index:3000;

      display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;
      padding:10px 12px;

      border-radius:0 0 14px 14px;
      background:var(--ui-bg);
      border:1px solid var(--ui-border);
      border-top:none;
      box-shadow:var(--ui-shadow);

      font:14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ui-text);
      backdrop-filter: blur(6px);
    }

    .brand{font-weight:900; white-space:nowrap; margin-right:4px;}
    .field{display:flex; flex-direction:column; gap:4px}
    .field label{font-size:11px; color:var(--ui-muted); margin-left:2px}
    .field input,.field select{
      height:34px;
      padding:0 10px;
      border-radius:10px;
      border:1px solid var(--inp-border);
      background:var(--inp-bg);
      color:var(--inp-text);
      outline:none;
      min-width: 120px;
    }
    .field input::placeholder{color:var(--inp-ph)}
    .field input:focus,.field select:focus{border-color:var(--inp-focus); box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .w240{min-width:240px}
    .w140{min-width:140px}
    .w110{min-width:110px}

    .btn{
      height:34px;
      padding:0 12px;
      border-radius:10px;
      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--btn-text);
      cursor:pointer;
      font-weight:800;
      transition: transform .06s ease, filter .15s ease;
    }
    .btn.primary{
      background:var(--btn-primary);
      border-color:var(--btn-primary);
      color:var(--btn-primary-text);
    }
    .btn:hover{filter:brightness(1.04)}
    .btn:active{transform:translateY(1px)}

    .pill{
      align-self:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--pill-border);
      background:var(--pill-bg);
      white-space:nowrap;
      font-weight:900;
      color:var(--ui-text);
      display:flex;
      gap:8px;
      align-items:center;
    }

    #loadStatus{ margin-left:auto; }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:rgba(148,163,184,.8);
      display:inline-block;
    }
    .dot.good{background:var(--good)}
    .dot.mid{background:var(--mid)}
    .dot.bad{background:var(--bad)}

    /* Autocomplete */
    .ac{
      position:absolute; z-index:4000;
      background:var(--ui-bg);
      border:1px solid var(--ui-border);
      border-radius:12px;
      box-shadow:var(--ui-shadow);
      overflow:hidden;
      font:14px/1.2 system-ui, Arial;
      color:var(--ui-text);
      max-height:260px;
      overflow:auto;
      min-width: 320px;
      display:none;
    }
    .ac .item{
      padding:10px 12px;
      border-bottom:1px solid var(--ui-border);
      cursor:pointer;
    }
    .ac .item:last-child{border-bottom:none}
    .ac .item:hover{background:var(--ui-soft)}
    .ac .name{font-weight:900}
    .ac .addr{font-size:12px; color:var(--ui-muted); margin-top:2px}

    /* Panel */
    .panel{
      position:absolute; top:88px; right:12px; z-index:2500;
      width:640px; max-height: calc(100vh - 110px);
      display:flex; flex-direction:column;
      background:var(--ui-bg);
      border:1px solid var(--ui-border);
      border-radius:16px;
      box-shadow:var(--ui-shadow);
      overflow:hidden;
      font:14px/1.25 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ui-text);
      user-select:none;
    }
    .panel.hidden{display:none;}
    .panel-h{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background:var(--ui-soft);
      border-bottom:1px solid var(--ui-border);
      cursor:move;
    }
    .panel-h .t{font-weight:900}
    .panel-h .x{
      width:30px;height:30px;border-radius:10px;border:1px solid var(--ui-border);
      background:var(--ui-soft2); color:var(--ui-text);
      cursor:pointer; font-weight:900;
    }
    .panel-b{padding:10px 12px; overflow:auto; user-select:text;}
    .kpis{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:10px;}
    .kpi{
      border:1px solid var(--ui-border);
      background:var(--ui-soft);
      border-radius:14px; padding:10px;
    }
    .kpi .h{font-size:12px; color:var(--ui-muted)}
    .kpi .v{font-weight:900; font-size:16px; margin-top:2px}
    .small{font-size:12px; color:var(--ui-muted)}

    .detail{
      border:1px solid var(--ui-border);
      background:var(--ui-soft);
      border-radius:14px; padding:10px;
      margin:10px 0 12px 0;
    }
    .detail .title{font-weight:900; margin-bottom:6px}
    .detail-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px 12px;
      font-size:13px;
    }
    .kv{display:flex; justify-content:space-between; gap:10px}
    .k{color:var(--ui-muted)}
    .v{font-weight:900}

    table{width:100%; border-collapse:collapse; font-size:13px;}
    th,td{padding:10px 6px; border-bottom:1px solid var(--ui-border); vertical-align:top; text-align:left;}
    th{
      font-size:12px; color:var(--ui-muted); font-weight:900;
      position:sticky; top:0; background:var(--ui-bg);
    }
    tr{cursor:pointer}
    tr:hover{background:var(--ui-soft)}
    .badge{
      display:inline-block; padding:3px 10px; border-radius:999px;
      font-size:12px; font-weight:900;
      border:1px solid var(--ui-border);
      background:var(--ui-soft);
      white-space:nowrap;
      color:var(--ui-text);
    }
    .good{background:rgba(22,163,74,.14); border-color:rgba(22,163,74,.35); color:var(--good)}
    .mid{background:rgba(245,158,11,.16); border-color:rgba(245,158,11,.35); color:var(--mid)}
    .bad{background:rgba(220,38,38,.14); border-color:rgba(220,38,38,.35); color:var(--bad)}

    .leaflet-popup-content-wrapper, .leaflet-popup-tip{
      background:var(--popup-bg);
      color:var(--popup-text);
      border:1px solid var(--popup-border);
      box-shadow:0 12px 34px rgba(2,6,23,.12);
    }
    .rcard{font:14px/1.25 system-ui, Arial; padding:8px; min-width:280px;}
    .rcard .h{font-weight:900;margin-bottom:6px}
    .rcard .r{display:flex; gap:8px; align-items:center; margin-top:6px}
    .rcard input{
      flex:1; padding:9px 10px; border-radius:12px;
      border:1px solid var(--inp-border);
      background:var(--inp-bg);
      color:var(--inp-text); outline:none;
    }
    .rcard .note{font-size:12px; color:var(--ui-muted); margin-top:6px}

    .tri{
      width:0;height:0;
      border-left:10px solid transparent;
      border-right:10px solid transparent;
      border-bottom:18px solid var(--cust-tri);
      filter: drop-shadow(0 3px 6px rgba(2,6,23,.25));
    }

    .deliv{
      margin-top:8px;
      border-top:1px solid var(--ui-border);
      padding-top:8px;
      font-size:13px;
    }
    .deliv .t{font-weight:900; margin-bottom:6px}
    .deliv .row{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px solid var(--ui-border)}
    .deliv .row:last-child{border-bottom:none}
    .deliv .f{font-weight:800}
    .deliv .n{font-weight:900; opacity:.95}

    .leaflet-control-zoom a{
      color:var(--map-zoom-text) !important;
      background:var(--map-zoom-bg) !important;
      border:1px solid var(--map-zoom-border) !important;
    }

    /* Mobile: Panel narrower */
    @media (max-width: 720px){
      .panel{width: calc(100vw - 24px); right:12px;}
      .kpis{grid-template-columns:1fr;}
      .detail-grid{grid-template-columns:1fr;}
      .w240{min-width: 200px;}
    }
  </style>
</head>

<body>
<div id="map"></div>

<div class="topbar" id="topbar">
  <div class="brand">Verkaufs-Karte</div>

  <div class="field w240">
    <label>Kunde suchen</label>
    <input id="custSearch" placeholder="Name / Ort â€¦">
  </div>

  <div class="field w140">
    <label>Produkt</label>
    <select id="product">
      <option value="lose">Lose</option>
      <option value="sackware">Sackware</option>
      <option value="industrieware">Industrieware</option>
    </select>
  </div>

  <div class="field w140">
    <label>Farbschema</label>
    <select id="colorScheme">
      <option value="standard">Standard</option>
      <option value="pink">Pink</option>
      <option value="pastel">Pastell</option>
    </select>
  </div>

  <div class="field w110">
    <label>UI</label>
    <button class="btn" id="btnTheme" title="Hell/Dunkel umschalten">ðŸŒ™</button>
  </div>

  <div class="field w140">
    <label>Radius (km)</label>
    <input id="radiusKm" type="number" min="0" value="250">
  </div>

  <div class="field w140">
    <label>Menge (t)</label>
    <input id="qtyT" type="number" min="0.1" step="0.1" value="24">
  </div>

  <div class="field w140">
    <label>Fracht â‚¬/km</label>
    <input id="freightPerKm" type="number" step="0.01" value="1.85">
  </div>

  <div class="field w140">
    <label>Faktor</label>
    <input id="factor" type="number" step="0.01" value="1.05" min="0" max="10">
  </div>

  <div class="field w140">
    <label>Ziel-VK â‚¬/t</label>
    <input id="targetVk" type="number" step="0.01" placeholder="optional">
  </div>

  <button class="btn primary" id="btnCalc">Berechnen</button>
  <button class="btn" id="btnGeo">Geocoden</button>

  <div class="pill" id="loadStatus"><span class="dot"></span> â€”</div>
  <div class="pill" id="miniKpi" title="SchnellÃ¼bersicht">
    <span class="dot good"></span><span id="miniGood">0</span>
    <span class="dot mid"></span><span id="miniMid">0</span>
    <span class="dot bad"></span><span id="miniBad">0</span>
  </div>
</div>

<div id="ac" class="ac"></div>

<div id="panel" class="panel">
  <div id="panelHeader" class="panel-h">
    <div class="t">Ergebnisse</div>
    <button id="closePanel" class="x" title="SchlieÃŸen">âœ•</button>
  </div>
  <div class="panel-b">
    <div class="kpis">
      <div class="kpi">
        <div class="h">Kunde</div>
        <div class="v" id="kpiCustomer">â€”</div>
        <div class="small" id="kpiCustomerAddr">â€”</div>
      </div>
      <div class="kpi">
        <div class="h">Treffer</div>
        <div class="v" id="kpiCount">â€”</div>
        <div class="small" id="kpiQty">Menge: â€”</div>
      </div>
      <div class="kpi">
        <div class="h">Routing</div>
        <div class="v" id="kpiRoute">â€”</div>
        <div class="small">Klick auf Zeile lÃ¤dt Route</div>
      </div>
    </div>

    <div class="detail" id="detailBox" style="display:none">
      <div class="title" id="detailTitle">Details</div>
      <div class="detail-grid" id="detailGrid"></div>
    </div>

    <div class="small" style="margin:6px 0 10px 0">
      Klick auf Zeile: Route + Details + kopiert Angebotstext. Rechtsklick auf Firma: Preis Ã¤ndern (Enter).
      Klick auf Karte: Route ausblenden.
    </div>

    <div id="results"></div>
  </div>
</div>

<script>
/* =========================
   SHEETS (deine Links)
   ========================= */
const CONFIG = {
  firmsCsvUrl: "https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/gviz/tq?tqx=out:csv&gid=0",
  customersCsvUrl: "https://docs.google.com/spreadsheets/d/1DaiLyZbhJkdSQ1PHbJQmguIrDnGrrhiAVgJC4PJO8vA/gviz/tq?tqx=out:csv&gid=0",
  deliveriesCsvUrl: "https://docs.google.com/spreadsheets/d/1fcvlM2BUDpoV-HDyPtgDf_1ZqWql6MdEMbisR0eqYYw/gviz/tq?tqx=out:csv&gid=0",
  geocodeDelayMs: 1100
};

/* =========================
   LocalStorage Keys
   ========================= */
const LS_GEO_CACHE_KEY = "salesMap_geoCache_v7";
const LS_PRICE_OVERRIDES_KEY = "salesMap_priceOverrides_v7";
const LS_PANEL_POS_KEY = "salesMap_panelPos_v7";
const LS_COLOR_SCHEME_KEY = "salesMap_colorScheme_v2";
const LS_THEME_KEY = "salesMap_theme_v1";

/* =========================
   State
   ========================= */
let map, customers=[], firms=[];
let customerMarkers=[], firmMarkers=[];
let selectedCustomer=null;
let routeLayer=null;
let lastRouteKm=null;

let deliveriesByCustomer = new Map();
let deliveriesLoaded = false;

let geoCache = loadLS(LS_GEO_CACHE_KEY, {});
let priceOverrides = loadLS(LS_PRICE_OVERRIDES_KEY, {});

/* =========================
   Init
   ========================= */
init();

async function init(){
  applyThemeFromLS();

  map = L.map('map', { worldCopyJump:true }).setView([51.2, 10.4], 6);

  // âœ… Moderner, cleaner Basemap
  // Light Theme: Carto Light
  // Dark Theme: Carto Dark (wird automatisch gewechselt)
  addBaseMap();

  initPanelDrag();
  initUI();

  map.on("click", ()=>{
    clearRoute();
    hideDetail();
  });

  setLoadStatus("Lade Tabellen â€¦");
  await Promise.all([loadCustomers(), loadFirms(), loadDeliveries()]);
  applyCacheCoordsOnly();
  renderMarkers();
  updateCustomerKpi(null);
  updateLoadStatusCounts();
  updateMiniKpis({good:0, mid:0, bad:0});
}

/* =========================
   Basemap switch (mit Fallback)
   ========================= */
let baseLayer = null;

function addBaseMap(){
  if(baseLayer){
    try{ map.removeLayer(baseLayer); }catch(e){}
    baseLayer = null;
  }

  const isDark = document.body.classList.contains("dark");

  // PrimÃ¤r: Carto
  const cartoUrl = isDark
    ? "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
    : "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png";

  // Fallback: OSM (fast immer erreichbar)
  const osmUrl = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";

  // erst Carto probieren
  baseLayer = L.tileLayer(cartoUrl, {
    attribution: "&copy; OpenStreetMap & Carto",
    subdomains: "abcd",
    maxZoom: 19
  }).addTo(map);

  // wenn Carto geblockt / down â†’ automatisch auf OSM wechseln
  let switched = false;
  baseLayer.on("tileerror", ()=>{
    if(switched) return;
    switched = true;

    try{ map.removeLayer(baseLayer); }catch(e){}
    baseLayer = L.tileLayer(osmUrl, {
      attribution: "&copy; OpenStreetMap contributors",
      maxZoom: 19
    }).addTo(map);

    setLoadStatus("âš ï¸ Basemap: Carto blockiert â†’ Fallback OSM aktiv");
  });

  // wenn nach kurzer Zeit immer noch nix geladen ist â†’ auch fallback
  setTimeout(()=>{
    if(switched) return;
    // wenn noch keine Tiles im DOM sind, ist meistens blockiert
    const anyTile = document.querySelector(".leaflet-tile-loaded");
    if(!anyTile){
      switched = true;
      try{ map.removeLayer(baseLayer); }catch(e){}
      baseLayer = L.tileLayer(osmUrl, {
        attribution: "&copy; OpenStreetMap contributors",
        maxZoom: 19
      }).addTo(map);
      setLoadStatus("âš ï¸ Basemap: kein Tile-Load â†’ Fallback OSM aktiv");
    }
  }, 1500);
}

/* =========================
   CSV with header normalize
   ========================= */
function parseCsv(url){
  return new Promise((resolve, reject)=>{
    Papa.parse(url, {
      download:true,
      header:true,
      skipEmptyLines:true,
      transformHeader: (h) => String(h||"").trim().toLowerCase(),
      complete: (res)=>resolve(res.data),
      error: reject
    });
  });
}

async function loadCustomers(){
  const rows = await parseCsv(CONFIG.customersCsvUrl);
  customers = rows.map((r, idx)=>{
    const name = str(r["name"] ?? r["kundenname"] ?? r["kunde"] ?? r["firma"] ?? r["unternehmen"]).trim();
    const ort  = str(r["ort"] ?? r["adresse"] ?? r["address"]).trim();
    return {
      id:"C"+idx,
      name: name || ort || "Kunde",
      address: ort,
      lat: NaN,
      lon: NaN,
      raw: r
    };
  }).filter(x=>x.address);
}

async function loadFirms(){
  const rows = await parseCsv(CONFIG.firmsCsvUrl);
  firms = rows.map((r, idx)=>{
    const name = str(r["firma"] ?? r["name"]).trim();
    const ort  = str(r["ort"] ?? r["adresse"] ?? r["address"]).trim();

    const baseLose = toNum(r["preis"]);
    const baseSack = toNum(r["sackware"]);
    const baseInd  = toNum(r["industriewar"] ?? r["industrieware"]);

    return {
      id:"F"+idx,
      name: name || "Firma",
      address: ort,
      base:{ lose: baseLose, sackware: baseSack, industrieware: baseInd },
      lat: NaN,
      lon: NaN,
      raw: r
    };
  }).filter(x=>x.name && x.address);
}

async function loadDeliveries(){
  try{
    const rows = await parseCsv(CONFIG.deliveriesCsvUrl);

    const mapTmp = new Map();
    for(const r of rows){
      const kunde = str(r["kunde"] ?? r["kundenname"] ?? r["customer"]).trim();
      const firma = str(r["firma"] ?? r["firm"] ?? r["lieferant"]).trim();
      const anzahl = toNum(r["anzahl"] ?? r["count"] ?? r["lieferungen"]);

      if(!kunde || !firma) continue;

      const k = normName(kunde);
      const arr = mapTmp.get(k) || [];
      arr.push({ firma, anzahl: (isFinite(anzahl) ? anzahl : 0) });
      mapTmp.set(k, arr);
    }

    for(const [k, arr] of mapTmp.entries()){
      arr.sort((a,b)=>(b.anzahl||0)-(a.anzahl||0));
    }

    deliveriesByCustomer = mapTmp;
    deliveriesLoaded = true;
  }catch(e){
    console.warn("Deliveries load error:", e);
    deliveriesByCustomer = new Map();
    deliveriesLoaded = false;
  }
}

/* =========================
   Geocoding + Cache
   ========================= */
function normAddr(a){ return str(a).trim().replace(/\s+/g,' '); }
function normName(s){ return str(s).trim().toLowerCase().replace(/\s+/g,' '); }

function applyCacheCoordsOnly(){
  customers.forEach(c=>{
    const hit = geoCache[normAddr(c.address)];
    if(hit){ c.lat=hit.lat; c.lon=hit.lon; }
  });
  firms.forEach(f=>{
    const hit = geoCache[normAddr(f.address)];
    if(hit){ f.lat=hit.lat; f.lon=hit.lon; }
  });
}

async function geocodeAddress(address){
  const key = normAddr(address);
  if(!key) return null;

  if(geoCache[key] && isFinite(geoCache[key].lat) && isFinite(geoCache[key].lon)){
    return {lat: geoCache[key].lat, lon: geoCache[key].lon};
  }

  const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(key);
  try{
    const res = await fetch(url, { headers: { "Accept":"application/json" } });
    const data = await res.json();
    if(data && data[0]){
      const lat = parseFloat(data[0].lat);
      const lon = parseFloat(data[0].lon);
      if(isFinite(lat) && isFinite(lon)){
        geoCache[key] = {lat, lon, ts: Date.now()};
        saveLS(LS_GEO_CACHE_KEY, geoCache);
        return {lat, lon};
      }
    }
  }catch(e){
    console.warn("Geocode error", e);
  }
  return null;
}

function updateLoadStatusCounts(prefix=""){
  const totalC = customers.length;
  const totalF = firms.length;
  const doneC = customers.filter(c=>isFinite(c.lat)&&isFinite(c.lon)).length;
  const doneF = firms.filter(f=>isFinite(f.lat)&&isFinite(f.lon)).length;

  const delivTxt = deliveriesLoaded ? ` Â· AuftrÃ¤ge âœ“` : ` Â· AuftrÃ¤ge â€”`;
  setLoadStatus(`${prefix}${prefix? " Â· ":""}Kunden ${doneC}/${totalC} Â· Firmen ${doneF}/${totalF}${delivTxt}`);
}

async function geocodeAll(){
  const totalC = customers.length;
  const totalF = firms.length;

  let doneC = customers.filter(c=>isFinite(c.lat)&&isFinite(c.lon)).length;
  let doneF = firms.filter(f=>isFinite(f.lat)&&isFinite(f.lon)).length;

  setLoadStatus(`Kunden ${doneC}/${totalC} Â· Firmen ${doneF}/${totalF}`);

  for(const c of customers){
    if(isFinite(c.lat) && isFinite(c.lon)) continue;
    const coords = await geocodeAddress(c.address);
    if(coords){
      c.lat = coords.lat; c.lon = coords.lon;
      doneC++;
      setLoadStatus(`Kunden ${doneC}/${totalC} Â· Firmen ${doneF}/${totalF}`);
    }
    await sleep(CONFIG.geocodeDelayMs);
  }

  for(const f of firms){
    if(isFinite(f.lat) && isFinite(f.lon)) continue;
    const coords = await geocodeAddress(f.address);
    if(coords){
      f.lat = coords.lat; f.lon = coords.lon;
      doneF++;
      setLoadStatus(`Kunden ${doneC}/${totalC} Â· Firmen ${doneF}/${totalF}`);
    }
    await sleep(CONFIG.geocodeDelayMs);
  }

  renderMarkers();
  if(selectedCustomer) updateCustomerKpi(selectedCustomer);
  setLoadStatus(`âœ… Fertig: Kunden ${doneC}/${totalC} Â· Firmen ${doneF}/${totalF}`);
}

/* =========================
   Markers
   ========================= */
function customerTriangleIcon(){
  return L.divIcon({ html:`<div class="tri"></div>`, className:"", iconSize:[20,18], iconAnchor:[10,18] });
}

function firmColorByProduct(product){
  const scheme = document.getElementById("colorScheme")?.value || "standard";

  const palettes = {
    standard: { lose: "#8b5cf6", sackware: "#a855f7", industrieware: "#6d28d9" },
    pink:     { lose: "#ec4899", sackware: "#f472b6", industrieware: "#fb7185" },
    pastel:   { lose: "#f9a8d4", sackware: "#fbcfe8", industrieware: "#fda4af" }
  };

  return palettes[scheme]?.[product] || "#8b5cf6";
}

function calcDeliveredForFirm(f, inputs){
  if(!selectedCustomer || !isFinite(selectedCustomer.lat) || !isFinite(selectedCustomer.lon)) return null;

  const kmAir = haversineKm(selectedCustomer.lat, selectedCustomer.lon, f.lat, f.lon);
  const override = priceOverrides?.[f.id]?.[inputs.product];
  const base = isFinite(override) ? override : f.base[inputs.product];
  if(!isFinite(base) || base <= 0) return null;

  const freightPerT = (kmAir * inputs.freightPerKm / inputs.qtyT) * inputs.factor;
  const deliveredPerT = base + freightPerT;

  let marginPerT = NaN;
  if(isFinite(inputs.targetVk)) marginPerT = inputs.targetVk - deliveredPerT;

  return { kmAir, base, freightPerT, deliveredPerT, marginPerT };
}

function firmFillColor(f, inputs){
  // Wenn Ziel-VK gesetzt ist: grÃ¼n/orange/rot nach Marge
  if(isFinite(inputs.targetVk)){
    const calc = calcDeliveredForFirm(f, inputs);
    if(!calc) return "#94a3b8";
    const m = calc.marginPerT;
    if(!isFinite(m)) return "#94a3b8";
    if(m >= 10) return "#16a34a";
    if(m >= 0)  return "#f59e0b";
    return "#dc2626";
  }
  // sonst: nach Produkt + Farbschema
  return firmColorByProduct(inputs.product);
}

function buildDeliveriesHtml(customerName){
  const k = normName(customerName);
  const arr = deliveriesByCustomer.get(k) || [];
  if(!arr.length){
    return `<div class="deliv"><div class="t">Beliefert von</div><div class="small">Keine EintrÃ¤ge gefunden.</div></div>`;
  }

  let total = 0;
  for(const a of arr) total += (isFinite(a.anzahl) ? a.anzahl : 0);

  const rows = arr.map(x=>{
    const n = isFinite(x.anzahl) ? x.anzahl : 0;
    return `<div class="row"><div class="f">${esc(x.firma)}</div><div class="n">${esc(String(n))}x</div></div>`;
  }).join("");

  return `
    <div class="deliv">
      <div class="t">Beliefert von <span class="small">(gesamt ${esc(String(total))}x)</span></div>
      ${rows}
    </div>
  `;
}

function renderMarkers(){
  customerMarkers.forEach(m=>m.remove());
  firmMarkers.forEach(m=>m.remove());
  customerMarkers=[]; firmMarkers=[];

  customers.forEach(c=>{
    if(!isFinite(c.lat)||!isFinite(c.lon)) return;
    const m = L.marker([c.lat,c.lon], {icon: customerTriangleIcon()}).addTo(map);

    m.bindTooltip(`<b>${esc(c.name)}</b><br>${esc(c.address)}`, {direction:"top"});

    m.on("click", ()=>{
      selectCustomer(c);

      const html = `
        <div class="rcard">
          <div class="h">${esc(c.name)}</div>
          <div class="small">${esc(c.address)}</div>
          ${buildDeliveriesHtml(c.name)}
        </div>
      `;
      L.popup({closeButton:true, autoClose:true, closeOnClick:true})
        .setLatLng([c.lat, c.lon])
        .setContent(html)
        .openOn(map);
    });

    customerMarkers.push(m);
  });

  const inputs = getInputs();
  const hoverOutline = document.body.classList.contains("dark")
    ? "rgba(229,231,235,.9)"
    : "rgba(15,23,42,.9)";

  firms.forEach(f=>{
    if(!isFinite(f.lat)||!isFinite(f.lon)) return;

    const fill = firmFillColor(f, inputs);

    const m = L.circleMarker([f.lat,f.lon], {
      radius: 7,
      color: hoverOutline,
      weight: 2,
      fillColor: fill,
      fillOpacity: .88
    }).addTo(map);

    m.bindTooltip(`<b>${esc(f.name)}</b><br>${esc(f.address)}`, {direction:"top"});

    // âœ… Glow / Highlight
    m.on("mouseover", ()=>{
      m.setStyle({ radius: 9, weight: 3, fillOpacity: 1 });
    });
    m.on("mouseout", ()=>{
      m.setStyle({ radius: 7, weight: 2, fillOpacity: .88 });
    });

    m.on("contextmenu", (e)=>openRightClickPricePopup(f, e.latlng));
    firmMarkers.push(m);
  });
}

/* Leaflet nach Layout-Ã„nderung */
function invalidateMapSizeSoon(){
  setTimeout(()=>{ try{ map.invalidateSize(); }catch(e){} }, 50);
}

/* =========================
   UI + Autocomplete
   ========================= */
function initUI(){
  document.getElementById("btnGeo").addEventListener("click", geocodeAll);
  document.getElementById("btnCalc").addEventListener("click", calculate);

  // Theme toggle
  document.getElementById("btnTheme").addEventListener("click", ()=>{
    document.body.classList.toggle("dark");
    saveLS(LS_THEME_KEY, document.body.classList.contains("dark") ? "dark" : "light");
    addBaseMap();
    renderMarkers();
    if(selectedCustomer) calculate();
  });

  document.getElementById("product").addEventListener("change", ()=>{
    renderMarkers();
    if(selectedCustomer) calculate();
  });

  // Farbschema merken
  const schemeSel = document.getElementById("colorScheme");
  const savedScheme = loadLS(LS_COLOR_SCHEME_KEY, "standard");
  schemeSel.value = savedScheme || "standard";

  schemeSel.addEventListener("change", ()=>{
    saveLS(LS_COLOR_SCHEME_KEY, schemeSel.value);
    renderMarkers();
    if(selectedCustomer) calculate();
  });

  // Ziel-VK live: Marker + Ergebnis neu
  document.getElementById("targetVk").addEventListener("input", ()=>{
    renderMarkers();
  });

  document.getElementById("closePanel").addEventListener("click", ()=>{
    document.getElementById("panel").classList.add("hidden");
    invalidateMapSizeSoon();
  });

  const input = document.getElementById("custSearch");
  const ac = document.getElementById("ac");

  function positionAC(){
    const r = input.getBoundingClientRect();
    ac.style.left = (r.left + window.scrollX) + "px";
    ac.style.top  = (r.bottom + window.scrollY + 8) + "px";
    ac.style.minWidth = Math.max(320, r.width) + "px";
  }
  window.addEventListener("resize", ()=>{ positionAC(); invalidateMapSizeSoon(); });
  window.addEventListener("scroll", positionAC, true);

  input.addEventListener("focus", ()=>{ positionAC(); showSuggestions(input.value); });
  input.addEventListener("input", ()=>{ positionAC(); showSuggestions(input.value); });

  input.addEventListener("keydown", (e)=>{
    if(e.key === "Escape") ac.style.display="none";
    if(e.key === "Enter"){
      const q = input.value.trim().toLowerCase();
      const found = bestCustomerMatch(q);
      if(found){
        selectCustomer(found);
        ac.style.display="none";

        if(isFinite(found.lat) && isFinite(found.lon)){
          const html = `
            <div class="rcard">
              <div class="h">${esc(found.name)}</div>
              <div class="small">${esc(found.address)}</div>
              ${buildDeliveriesHtml(found.name)}
            </div>
          `;
          L.popup({closeButton:true, autoClose:true, closeOnClick:true})
            .setLatLng([found.lat, found.lon])
            .setContent(html)
            .openOn(map);
        }
      }
    }
  });

  document.addEventListener("click", (e)=>{
    if(e.target === input) return;
    if(ac.contains(e.target)) return;
    ac.style.display="none";
  });

  function bestCustomerMatch(q){
    if(!q) return null;
    const starts = customers.filter(c => (c.name||"").toLowerCase().startsWith(q));
    if(starts.length) return starts[0];
    const contains = customers.filter(c => (c.name||"").toLowerCase().includes(q) || (c.address||"").toLowerCase().includes(q));
    return contains[0] || null;
  }

  function showSuggestions(qRaw){
    const q = (qRaw||"").trim().toLowerCase();
    ac.innerHTML = "";
    if(!q){ ac.style.display="none"; return; }

    const starts=[], contains=[];
    for(const c of customers){
      const name=(c.name||"").toLowerCase();
      const addr=(c.address||"").toLowerCase();
      if(name.startsWith(q) || addr.startsWith(q)) starts.push(c);
      else if(name.includes(q) || addr.includes(q)) contains.push(c);
    }

    const list=[...starts,...contains].slice(0,12);
    if(!list.length){ ac.style.display="none"; return; }

    for(const c of list){
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `<div class="name">${esc(c.name)}</div><div class="addr">${esc(c.address)}</div>`;
      div.addEventListener("click", ()=>{
        selectCustomer(c);
        ac.style.display="none";
        input.blur();
      });
      ac.appendChild(div);
    }
    ac.style.display="block";
  }
}

function applyThemeFromLS(){
  const t = loadLS(LS_THEME_KEY, "light");
  if(t === "dark") document.body.classList.add("dark");
}

function setLoadStatus(text){
  const el = document.getElementById("loadStatus");
  el.innerHTML = `<span class="dot"></span> ${esc(text)}`;
}

/* =========================
   Customer selection
   ========================= */
function selectCustomer(c){
  selectedCustomer = c;
  updateCustomerKpi(c);
  hideDetail();

  if(isFinite(c.lat)&&isFinite(c.lon)){
    map.setView([c.lat,c.lon], Math.max(map.getZoom(), 7), {animate:true});
  }
  document.getElementById("panel").classList.remove("hidden");
  invalidateMapSizeSoon();

  // Marker neu fÃ¤rben (Marge-Farben)
  renderMarkers();
}

/* =========================
   Inputs
   ========================= */
function getInputs(){
  const factor = toNum(document.getElementById("factor").value);
  return {
    product: document.getElementById("product").value,
    radiusKm: toNum(document.getElementById("radiusKm").value) || 250,
    qtyT: Math.max(0.1, toNum(document.getElementById("qtyT").value) || 24),
    freightPerKm: toNum(document.getElementById("freightPerKm").value) || 1.85,
    factor: isFinite(factor) ? factor : 1.05,
    targetVk: toNum(document.getElementById("targetVk").value)
  };
}

/* =========================
   Calculate (uses Luftlinie for km)
   ========================= */
function calculate(){
  const out = document.getElementById("results");
  out.innerHTML = "";
  hideDetail();
  clearRoute();

  if(!selectedCustomer || !isFinite(selectedCustomer.lat) || !isFinite(selectedCustomer.lon)){
    out.innerHTML = `<div class="small">Bitte zuerst einen Kunden auswÃ¤hlen (ggf. einmal â€žGeocodenâ€œ drÃ¼cken).</div>`;
    document.getElementById("kpiCount").textContent = "â€”";
    updateMiniKpis({good:0, mid:0, bad:0});
    return;
  }

  const inputs = getInputs();
  const {product, radiusKm, qtyT, freightPerKm, factor, targetVk} = inputs;

  document.getElementById("kpiQty").textContent = `Menge: ${fmt(qtyT,1)} t`;
  document.getElementById("kpiRoute").textContent = "â€”";

  const results = [];

  for(const f of firms){
    if(!isFinite(f.lat)||!isFinite(f.lon)) continue;

    const kmAir = haversineKm(selectedCustomer.lat, selectedCustomer.lon, f.lat, f.lon);
    if(kmAir > radiusKm) continue;

    const override = priceOverrides?.[f.id]?.[product];
    const base = isFinite(override) ? override : f.base[product];
    if(!isFinite(base) || base <= 0) continue;

    const freightPerT = (kmAir * freightPerKm / qtyT) * factor;
    const deliveredPerT = base + freightPerT;
    const deliveredTotal = deliveredPerT * qtyT;

    let marginPerT = null, marginTotal = null;
    if(isFinite(targetVk)){
      marginPerT = targetVk - deliveredPerT;
      marginTotal = marginPerT * qtyT;
    }

    results.push({f, kmAir, base, freightPerT, deliveredPerT, deliveredTotal, marginPerT, marginTotal});
  }

  results.sort((a,b)=>a.deliveredPerT - b.deliveredPerT);
  document.getElementById("kpiCount").textContent = String(results.length);

  // Mini-KPIs: grÃ¼n/orange/rot counts
  const counts = {good:0, mid:0, bad:0};
  if(isFinite(targetVk)){
    for(const r of results){
      const m = r.marginPerT;
      if(!isFinite(m)) continue;
      if(m >= 10) counts.good++;
      else if(m >= 0) counts.mid++;
      else counts.bad++;
    }
  }
  updateMiniKpis(counts);

  // Marker neu (jetzt mit Marge-Farben)
  renderMarkers();

  if(!results.length){
    out.innerHTML = `<div class="small">Keine Firmen im Radius / mit gÃ¼ltigem Preis gefunden.</div>`;
    return;
  }

  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th>Firma</th>
        <th>KM</th>
        <th>Preis</th>
        <th>${isFinite(targetVk) ? "Marge" : "Info"}</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  for(const row of results){
    const badge = makeBadge(row, targetVk);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <b>${esc(row.f.name)}</b><br>
        <span class="small">${esc(row.f.address)} Â· Basis ${fmt(row.base)} â‚¬/t Â· Fracht ${fmt(row.freightPerT)} â‚¬/t</span>
      </td>
      <td>${fmt(row.kmAir,0)}</td>
      <td>
        <b>${fmt(row.deliveredPerT)} â‚¬/t</b><br>
        <span class="small">${fmt(row.deliveredTotal)} â‚¬ fÃ¼r ${fmt(qtyT,1)} t</span>
      </td>
      <td>${badge}</td>
    `;

    tr.addEventListener("click", async ()=>{
      const routeKm = await drawRouteOSRM(selectedCustomer, row.f);
      showDetail(row, inputs, routeKm);
      await copyOfferText(selectedCustomer, row, inputs, routeKm);
    });

    tbody.appendChild(tr);
  }

  out.appendChild(table);
}

function updateMiniKpis({good, mid, bad}){
  document.getElementById("miniGood").textContent = String(good ?? 0);
  document.getElementById("miniMid").textContent  = String(mid ?? 0);
  document.getElementById("miniBad").textContent  = String(bad ?? 0);
}

function makeBadge(row, targetVk){
  if(!isFinite(targetVk)){
    return `<span class="badge">Klick = Route</span>`;
  }
  const m = row.marginPerT;
  if(!isFinite(m)) return `<span class="badge">â€”</span>`;
  if(m >= 10) return `<span class="badge good">+${fmt(m)} â‚¬/t</span>`;
  if(m >= 0)  return `<span class="badge mid">+${fmt(m)} â‚¬/t</span>`;
  return `<span class="badge bad">${fmt(m)} â‚¬/t</span>`;
}

/* =========================
   Routing OSRM
   ========================= */
function clearRoute(){
  if(routeLayer){
    try{ map.removeLayer(routeLayer); }catch(e){}
    routeLayer = null;
  }
  lastRouteKm = null;
  const el = document.getElementById("kpiRoute");
  if(el) el.textContent = "â€”";
}

async function drawRouteOSRM(from, to){
  clearRoute();
  document.getElementById("kpiRoute").textContent = "lÃ¤dtâ€¦";

  const url = `https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=full&geometries=geojson`;
  try{
    const res = await fetch(url);
    const data = await res.json();

    if(data && data.routes && data.routes[0] && data.routes[0].geometry){
      const geom = data.routes[0].geometry;
      const meters = data.routes[0].distance;
      const km = isFinite(meters) ? (meters/1000) : null;
      lastRouteKm = km;

      routeLayer = L.geoJSON(geom, {style:{weight:4}}).addTo(map);
      map.fitBounds(routeLayer.getBounds().pad(0.25), {animate:true});

      document.getElementById("kpiRoute").textContent = km ? `${fmt(km,1)} km` : "OK";
      return km;
    }
  }catch(e){
    console.warn("Routing error", e);
  }

  routeLayer = L.polyline([[from.lat,from.lon],[to.lat,to.lon]], {weight:4}).addTo(map);
  map.fitBounds(routeLayer.getBounds().pad(0.25), {animate:true});
  document.getElementById("kpiRoute").textContent = "Fallback";
  return null;
}

/* =========================
   Detail Box
   ========================= */
function kv(k, v){
  return `<div class="kv"><div class="k">${esc(k)}</div><div class="v">${esc(v)}</div></div>`;
}

function showDetail(row, inputs, routeKm){
  const {product, qtyT, freightPerKm, factor, targetVk} = inputs;

  const detailBox = document.getElementById("detailBox");
  const title = document.getElementById("detailTitle");
  const grid = document.getElementById("detailGrid");

  title.textContent = `Details: ${row.f.name}`;

  const routeText = (routeKm && isFinite(routeKm)) ? `${fmt(routeKm,1)} km` : "â€”";
  const airText = `${fmt(row.kmAir,1)} km`;

  const marginPerT = isFinite(targetVk) ? (targetVk - row.deliveredPerT) : NaN;
  const profitTotal = isFinite(marginPerT) ? (marginPerT * qtyT) : NaN;

  grid.innerHTML = `
    ${kv("Adresse", row.f.address)}
    ${kv("Produkt", productLabel(product))}
    ${kv("Menge", `${fmt(qtyT,1)} t`)}
    ${kv("Route (km)", routeText)}
    ${kv("Luftlinie (km)", airText)}
    ${kv("Basis", `${fmt(row.base)} â‚¬/t`)}
    ${kv("Fracht", `${fmt(row.freightPerT)} â‚¬/t`)}
    ${kv("Lieferpreis", `${fmt(row.deliveredPerT)} â‚¬/t`)}
    ${kv("Gesamtpreis", `${fmt(row.deliveredTotal)} â‚¬`)}
    ${kv("Ziel-VK", isFinite(targetVk) ? `${fmt(targetVk)} â‚¬/t` : "â€”")}
    ${kv("Marge", isFinite(marginPerT) ? `${fmt(marginPerT)} â‚¬/t` : "â€”")}
    ${kv("Gewinn gesamt", isFinite(profitTotal) ? `${fmt(profitTotal)} â‚¬` : "â€”")}
    ${kv("Fracht â‚¬/km", `${fmt(freightPerKm)} â‚¬`)}
    ${kv("Faktor", `${fmt(factor,2)}`)}
  `;

  detailBox.style.display = "block";
}

function hideDetail(){
  document.getElementById("detailBox").style.display="none";
  document.getElementById("detailGrid").innerHTML="";
  document.getElementById("detailTitle").textContent="Details";
}

/* =========================
   Right click price edit (per product)
   ========================= */
function openRightClickPricePopup(firm, latlng){
  const product = document.getElementById("product").value;
  const currentOverride = priceOverrides?.[firm.id]?.[product];
  const current = isFinite(currentOverride) ? currentOverride : firm.base[product];

  const div = document.createElement("div");
  div.className="rcard";
  div.innerHTML = `
    <div class="h">${esc(firm.name)}</div>
    <div class="small">Preis fÃ¼r <b>${esc(productLabel(product))}</b> (â‚¬/t)</div>
    <div class="r"><input id="priceInput" type="number" step="0.01" value="${isFinite(current)?current:""}"></div>
    <div class="note">Enter = speichern Â· Esc = schlieÃŸen</div>
  `;

  const popup = L.popup({closeButton:true, autoClose:true, closeOnClick:true})
    .setLatLng(latlng)
    .setContent(div)
    .openOn(map);

  setTimeout(()=>{
    const inp = div.querySelector("#priceInput");
    inp.focus(); inp.select();

    inp.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        const v = toNum(inp.value);
        if(isFinite(v) && v>0){
          priceOverrides[firm.id] = priceOverrides[firm.id] || {};
          priceOverrides[firm.id][product] = v;
          saveLS(LS_PRICE_OVERRIDES_KEY, priceOverrides);
          map.closePopup(popup);
          renderMarkers();
          calculate();
        }
      }
      if(e.key==="Escape"){
        map.closePopup(popup);
      }
    });
  }, 30);
}

/* =========================
   Copy offer text
   ========================= */
async function copyOfferText(customer, row, inputs, routeKm){
  const {product, qtyT, freightPerKm, factor, targetVk} = inputs;
  const marginPerT = isFinite(targetVk) ? (targetVk - row.deliveredPerT) : NaN;
  const profitTotal = isFinite(marginPerT) ? (marginPerT * qtyT) : NaN;

  const text =
`Angebots-Vorschlag
Kunde: ${customer.name}
Adresse: ${customer.address}
Produkt: ${productLabel(product)}
Menge: ${qtyT} t

Firma: ${row.f.name}
Adresse: ${row.f.address}
Luftlinie: ${row.kmAir.toFixed(1)} km
Route: ${routeKm && isFinite(routeKm) ? routeKm.toFixed(1) : "â€”"} km

Basis: ${round2(row.base)} â‚¬/t
Fracht: ${round2(row.freightPerT)} â‚¬/t
Lieferpreis: ${round2(row.deliveredPerT)} â‚¬/t
Gesamt: ${round2(row.deliveredTotal)} â‚¬ fÃ¼r ${qtyT} t

Ziel-VK: ${isFinite(targetVk) ? round2(targetVk) : "â€”"} â‚¬/t
Marge: ${isFinite(marginPerT) ? round2(marginPerT) : "â€”"} â‚¬/t
Gewinn gesamt: ${isFinite(profitTotal) ? round2(profitTotal) : "â€”"} â‚¬

Fracht â‚¬/km: ${freightPerKm} | Faktor: ${factor}`;

  try{
    await navigator.clipboard.writeText(text);
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value=text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
  }
}

/* =========================
   Panel drag + persist
   ========================= */
function initPanelDrag(){
  const panel = document.getElementById("panel");
  const header = document.getElementById("panelHeader");

  const pos = loadLS(LS_PANEL_POS_KEY, null);
  if(pos && isFinite(pos.x) && isFinite(pos.y)){
    panel.style.left = pos.x+"px";
    panel.style.top  = pos.y+"px";
    panel.style.right = "auto";
  }

  let dragging=false, sx=0, sy=0, sl=0, st=0;

  header.addEventListener("mousedown",(e)=>{
    dragging=true;
    const r = panel.getBoundingClientRect();
    sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top;
    panel.style.right="auto";
    e.preventDefault();
  });

  window.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    const x = Math.max(6, sl + (e.clientX-sx));
    const y = Math.max(6, st + (e.clientY-sy));
    panel.style.left = x+"px";
    panel.style.top  = y+"px";
  });

  window.addEventListener("mouseup",()=>{
    if(!dragging) return;
    dragging=false;
    const r = panel.getBoundingClientRect();
    saveLS(LS_PANEL_POS_KEY, {x:r.left, y:r.top});
  });
}

/* =========================
   KPI updates
   ========================= */
function updateCustomerKpi(c){
  if(!c){
    document.getElementById("kpiCustomer").textContent = "â€”";
    document.getElementById("kpiCustomerAddr").textContent = "â€”";
    document.getElementById("kpiCount").textContent = "â€”";
    document.getElementById("kpiRoute").textContent = "â€”";
    document.getElementById("kpiQty").textContent = "Menge: â€”";
    return;
  }
  document.getElementById("kpiCustomer").textContent = c.name || "â€”";
  document.getElementById("kpiCustomerAddr").textContent = c.address || "â€”";
  document.getElementById("kpiRoute").textContent = "â€”";
}

/* =========================
   Helpers
   ========================= */
function toNum(v){
  if(v===null || v===undefined) return NaN;
  if(typeof v==="number") return v;
  const s = String(v).trim().replace(",", ".");
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : NaN;
}
function str(v){ return (v===null||v===undefined) ? "" : String(v); }
function fmt(n, dec=2){
  if(!isFinite(n)) return "â€”";
  return n.toFixed(dec).replace(".", ",");
}
function round2(n){ return Math.round(n*100)/100; }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function esc(s){
  return String(s).replace(/[&<>"']/g, m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function productLabel(p){
  if(p==="lose") return "Lose";
  if(p==="sackware") return "Sackware";
  if(p==="industrieware") return "Industrieware";
  return p;
}
function haversineKm(lat1, lon1, lat2, lon2){
  const R = 6371;
  const toRad = d => d * Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*(Math.sin(dLon/2)**2);
  return 2*R*Math.asin(Math.sqrt(a));
}
function saveLS(key, obj){
  try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
}
function loadLS(key, fallback){
  try{
    const s = localStorage.getItem(key);
    return s ? JSON.parse(s) : fallback;
  }catch(e){ return fallback; }
}
</script>
</body>
</html>
