/* =========================
   UI + Autocomplete
   ========================= */
function initUI(){
  document.getElementById("btnGeo").addEventListener("click", geocodeAll);
  document.getElementById("btnCalc").addEventListener("click", calculate);

  // ✅ PLZ/Ort springen
  document.getElementById("btnPlace").addEventListener("click", async ()=>{
    const q = document.getElementById("placeSearch").value.trim();
    if(!q) return;
    setLoadStatus("Suche Ort/PLZ …");
    const coords = await geocodePlace(q);
    if(coords){
      map.setView([coords.lat, coords.lon], 10, {animate:true});
      setLoadStatus("✅ Ort gefunden");
    }else{
      setLoadStatus("⚠️ Nicht gefunden");
    }
    updateLoadStatusCounts();
  });
  document.getElementById("placeSearch").addEventListener("keydown", (e)=>{
    if(e.key==="Enter") document.getElementById("btnPlace").click();
  });

  // ✅ Zonen toggle
  document.getElementById("btnZones").addEventListener("click", ()=>{
    toggleZones();
    document.getElementById("btnZones").textContent = drawEnabled ? "✅ Aktiv" : "✏️ Zeichnen";
  });

  document.getElementById("btnTheme").addEventListener("click", ()=>{
    document.body.classList.toggle("dark");
    saveLS(LS_THEME_KEY, document.body.classList.contains("dark") ? "dark" : "light");
    renderMarkers();
    if(selectedCustomer) calculate();
  });

  document.getElementById("product").addEventListener("change", ()=>{
    renderMarkers();
    if(selectedCustomer) calculate();
  });

  const schemeSel = document.getElementById("colorScheme");
  const savedScheme = loadLS(LS_COLOR_SCHEME_KEY, "standard");
  schemeSel.value = savedScheme || "standard";
  schemeSel.addEventListener("change", ()=>{
    saveLS(LS_COLOR_SCHEME_KEY, schemeSel.value);
    renderMarkers();
    if(selectedCustomer) calculate();
  });

  document.getElementById("closePanel").addEventListener("click", ()=>{
    document.getElementById("panel").classList.add("hidden");
    setTimeout(()=>map.invalidateSize(), 50);
  });

  const input = document.getElementById("custSearch");
  const ac = document.getElementById("ac");

  function positionAC(){
    const r = input.getBoundingClientRect();
    ac.style.left = (r.left + window.scrollX) + "px";
    ac.style.top  = (r.bottom + window.scrollY + 8) + "px";
    ac.style.minWidth = Math.max(320, r.width) + "px";
  }
  window.addEventListener("resize", positionAC);
  window.addEventListener("scroll", positionAC, true);

  input.addEventListener("focus", ()=>{ positionAC(); showSuggestions(input.value); });
  input.addEventListener("input", ()=>{ positionAC(); showSuggestions(input.value); });

  input.addEventListener("keydown", (e)=>{
    if(e.key === "Escape") ac.style.display="none";
    if(e.key === "Enter"){
      const q = input.value.trim().toLowerCase();
      const found = bestCustomerMatch(q);
      if(found){
        selectCustomer(found);
        ac.style.display="none";
      }
    }
  });

  document.addEventListener("click", (e)=>{
    if(e.target === input) return;
    if(ac.contains(e.target)) return;
    ac.style.display="none";
  });

  function bestCustomerMatch(q){
    if(!q) return null;
    const starts = customers.filter(c => (c.name||"").toLowerCase().startsWith(q));
    if(starts.length) return starts[0];
    const contains = customers.filter(c => (c.name||"").toLowerCase().includes(q) || (c.address||"").toLowerCase().includes(q));
    return contains[0] || null;
  }

  function showSuggestions(qRaw){
    const q = (qRaw||"").trim().toLowerCase();
    ac.innerHTML = "";
    if(!q){ ac.style.display="none"; return; }

    const starts=[], contains=[];
    for(const c of customers){
      const name=(c.name||"").toLowerCase();
      const addr=(c.address||"").toLowerCase();
      if(name.startsWith(q) || addr.startsWith(q)) starts.push(c);
      else if(name.includes(q) || addr.includes(q)) contains.push(c);
    }

    const list=[...starts,...contains].slice(0,12);
    if(!list.length){ ac.style.display="none"; return; }

    for(const c of list){
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `<div class="name">${esc(c.name)}</div><div class="addr">${esc(c.address)}</div>`;
      div.addEventListener("click", ()=>{
        selectCustomer(c);
        ac.style.display="none";
        input.blur();
      });
      ac.appendChild(div);
    }
    ac.style.display="block";
  }
}

function applyThemeFromLS(){
  const t = loadLS(LS_THEME_KEY, "light");
  if(t === "dark") document.body.classList.add("dark");
}

function setLoadStatus(text){
  const el = document.getElementById("loadStatus");
  el.innerHTML = `<span class="dot"></span> ${esc(text)}`;
}

/* =========================
   Customer selection
   ========================= */
function selectCustomer(c){
  selectedCustomer = c;
  updateCustomerKpi(c);
  hideDetail();

  renderOrdersForCustomer(c);

  if(isFinite(c.lat)&&isFinite(c.lon)){
    map.setView([c.lat,c.lon], Math.max(map.getZoom(), 7), {animate:true});
  }
  document.getElementById("panel").classList.remove("hidden");
  setTimeout(()=>map.invalidateSize(), 50);

  renderMarkers();
}

/* ✅ AUFTRÄGE PANEL */
function renderOrdersForCustomer(c){
  const box = document.getElementById("ordersBox");
  const title = document.getElementById("ordersTitle");
  const listEl = document.getElementById("ordersList");

  if(!c){
    box.style.display="none";
    listEl.innerHTML="";
    return;
  }

  if(!deliveriesLoaded){
    box.style.display="block";
    title.textContent = "Aufträge";
    listEl.innerHTML = "—";
    return;
  }

  const k = normText(c.name);
  const list = deliveriesByCustomer.get(k) || [];

  box.style.display="block";
  title.textContent = `Aufträge (${list.length} Firmen)`;

  if(!list.length){
    listEl.innerHTML = "Keine Aufträge für diesen Kunden in der Aufträge-Tabelle gefunden.";
    return;
  }

  const rows = list.slice(0, 50).map(x=>{
    const a = Number.isFinite(x.anzahl) ? x.anzahl : 0;
    return `<div class="kv"><div class="k">${esc(x.firma)}</div><div class="v">${esc(String(a))}</div></div>`;
  }).join("");

  listEl.innerHTML = `<div class="detail-grid">${rows}</div>`;
}

/* =========================
   Inputs
   ========================= */
function getInputs(){
  const factor = toNum(document.getElementById("factor").value);
  return {
    product: document.getElementById("product").value,
    radiusKm: toNum(document.getElementById("radiusKm").value) || 250,
    qtyT: Math.max(0.1, toNum(document.getElementById("qtyT").value) || 24),
    freightPerKm: toNum(document.getElementById("freightPerKm").value) || 1.85,
    factor: isFinite(factor) ? factor : 1.05,
    targetVk: toNum(document.getElementById("targetVk").value)
  };
}

/* =========================
   Calculate
   ========================= */
function calculate(){
  const out = document.getElementById("results");
  out.innerHTML = "";
  hideDetail();
  clearRoute();

  if(!selectedCustomer || !isFinite(selectedCustomer.lat) || !isFinite(selectedCustomer.lon)){
    out.innerHTML = `<div class="small">Bitte zuerst einen Kunden auswählen (ggf. einmal „Geocoden“ drücken).</div>`;
    document.getElementById("kpiCount").textContent = "—";
    updateMiniKpis({good:0, mid:0, bad:0});
    return;
  }

  const inputs = getInputs();
  const {product, radiusKm, qtyT, freightPerKm, factor, targetVk} = inputs;

  if(selectedCustomer.accepts && selectedCustomer.accepts[product] === false){
    out.innerHTML = `<div class="small">
      ⚠️ <b>${esc(selectedCustomer.name)}</b> nimmt <b>${esc(productLabel(product))}</b> laut Kunden-Tabelle nicht an.
      <br>Bitte Produkt wechseln oder in der Kunden-Sheet auf <b>ja</b> setzen.
    </div>`;
    document.getElementById("kpiCount").textContent = "0";
    updateMiniKpis({good:0, mid:0, bad:0});
    renderMarkers();
    return;
  }

  document.getElementById("kpiQty").textContent = `Menge: ${fmt(qtyT,1)} t`;
  document.getElementById("kpiRoute").textContent = "—";

  const results = [];
  for(const f of firms){
    if(!isFinite(f.lat)||!isFinite(f.lon)) continue;

    const kmAir = haversineKm(selectedCustomer.lat, selectedCustomer.lon, f.lat, f.lon);
    if(kmAir > radiusKm) continue;

    const override = priceOverrides?.[f.id]?.[product];
    const base = isFinite(override) ? override : f.base[product];
    if(!isFinite(base) || base <= 0) continue;

    // ✅ Pellet-Formel
    const freightPerT = (kmAir * freightPerKm / qtyT) * factor;
    const deliveredPerT = base + freightPerT;
    const deliveredTotal = deliveredPerT * qtyT;

    let marginPerT = null;
    if(isFinite(targetVk)) marginPerT = targetVk - deliveredPerT;

    results.push({f, kmAir, base, freightPerT, deliveredPerT, deliveredTotal, marginPerT});
  }

  results.sort((a,b)=>a.deliveredPerT - b.deliveredPerT);
  document.getElementById("kpiCount").textContent = String(results.length);

  const counts = {good:0, mid:0, bad:0};
  if(isFinite(targetVk)){
    for(const r of results){
      const m = r.marginPerT;
      if(!isFinite(m)) continue;
      if(m >= 10) counts.good++;
      else if(m >= 0) counts.mid++;
      else counts.bad++;
    }
  }
  updateMiniKpis(counts);

  renderMarkers();

  if(!results.length){
    out.innerHTML = `<div class="small">Keine Firmen im Radius / mit gültigem Preis gefunden.</div>`;
    return;
  }

  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th>Firma</th>
        <th>KM</th>
        <th>Preis</th>
        <th>${isFinite(targetVk) ? "Marge" : "Info"}</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  for(const row of results){
    const standTxt = row.f.stand ? ` · ${esc(row.f.stand)}` : "";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <b>${esc(row.f.name)}</b><br>
        <span class="small">${esc(row.f.address)} · Basis ${fmt(row.base)} €/t${standTxt} · Fracht ${fmt(row.freightPerT)} €/t</span>
      </td>
      <td>${fmt(row.kmAir,0)}</td>
      <td>
        <b>${fmt(row.deliveredPerT)} €/t</b><br>
        <span class="small">${fmt(row.deliveredTotal)} € für ${fmt(qtyT,1)} t</span>
      </td>
      <td>${makeBadge(row, targetVk)}</td>
    `;

    tr.addEventListener("click", async ()=>{
      const routeKm = await drawRouteOSRM(selectedCustomer, row.f);
      showDetail(row, inputs, routeKm);
      await copyOfferText(selectedCustomer, row, inputs, routeKm);
    });

    tbody.appendChild(tr);
  }

  out.appendChild(table);
}

function updateMiniKpis({good, mid, bad}){
  document.getElementById("miniGood").textContent = String(good ?? 0);
  document.getElementById("miniMid").textContent  = String(mid ?? 0);
  document.getElementById("miniBad").textContent  = String(bad ?? 0);
}

function makeBadge(row, targetVk){
  if(!isFinite(targetVk)) return `<span class="badge">Klick = Route</span>`;
  const m = row.marginPerT;
  if(!isFinite(m)) return `<span class="badge">—</span>`;
  if(m >= 10) return `<span class="badge good">+${fmt(m)} €/t</span>`;
  if(m >= 0)  return `<span class="badge mid">+${fmt(m)} €/t</span>`;
  return `<span class="badge bad">${fmt(m)} €/t</span>`;
}

/* =========================
   Routing
   ========================= */
function clearRoute(){
  if(routeLayer){
    try{ map.removeLayer(routeLayer); }catch(e){}
    routeLayer = null;
  }
  const el = document.getElementById("kpiRoute");
  if(el) el.textContent = "—";
}

async function drawRouteOSRM(from, to){
  clearRoute();
  document.getElementById("kpiRoute").textContent = "lädt…";

  const url = `https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=full&geometries=geojson`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    if(data?.routes?.[0]?.geometry){
      const geom = data.routes[0].geometry;
      const km = isFinite(data.routes[0].distance) ? (data.routes[0].distance/1000) : null;

      routeLayer = L.geoJSON(geom, {style:{weight:4}}).addTo(map);
      map.fitBounds(routeLayer.getBounds().pad(0.25), {animate:true});
      document.getElementById("kpiRoute").textContent = km ? `${fmt(km,1)} km` : "OK";
      return km;
    }
  }catch(e){}

  routeLayer = L.polyline([[from.lat,from.lon],[to.lat,to.lon]], {weight:4}).addTo(map);
  map.fitBounds(routeLayer.getBounds().pad(0.25), {animate:true});
  document.getElementById("kpiRoute").textContent = "Fallback";
  return null;
}

/* =========================
   Detail
   ========================= */
function kv(k, v){
  return `<div class="kv"><div class="k">${esc(k)}</div><div class="v">${esc(v)}</div></div>`;
}

function showDetail(row, inputs, routeKm){
  const {product, qtyT, freightPerKm, factor, targetVk} = inputs;

  const detailBox = document.getElementById("detailBox");
  const title = document.getElementById("detailTitle");
  const grid = document.getElementById("detailGrid");

  title.textContent = `Details: ${row.f.name}`;

  const routeText = (routeKm && isFinite(routeKm)) ? `${fmt(routeKm,1)} km` : "—";
  const airText = `${fmt(row.kmAir,1)} km`;

  const marginPerT = isFinite(targetVk) ? (targetVk - row.deliveredPerT) : NaN;
  const profitTotal = isFinite(marginPerT) ? (marginPerT * qtyT) : NaN;

  const zoneName = (isFinite(row.f.lat) && isFinite(row.f.lon)) ? getZoneNameForLatLng(row.f.lat, row.f.lon) : "";
  const note = (notesStore?.[row.f.id] || "").trim();

  grid.innerHTML = `
    ${kv("Adresse", row.f.address)}
    ${kv("Stand", row.f.stand ? row.f.stand : "—")}
    ${kv("Zone", zoneName || "—")}
    ${kv("Produkt", productLabel(product))}
    ${kv("Menge", `${fmt(qtyT,1)} t`)}
    ${kv("Route (km)", routeText)}
    ${kv("Luftlinie (km)", airText)}
    ${kv("Basis", `${fmt(row.base)} €/t`)}
    ${kv("Fracht", `${fmt(row.freightPerT)} €/t`)}
    ${kv("Lieferpreis", `${fmt(row.deliveredPerT)} €/t`)}
    ${kv("Gesamtpreis", `${fmt(row.deliveredTotal)} €`)}
    ${kv("Ziel-VK", isFinite(targetVk) ? `${fmt(targetVk)} €/t` : "—")}
    ${kv("Marge", isFinite(marginPerT) ? `${fmt(marginPerT)} €/t` : "—")}
    ${kv("Gewinn gesamt", isFinite(profitTotal) ? `${fmt(profitTotal)} €` : "—")}
    ${kv("Fracht €/km", `${fmt(freightPerKm)} €`)}
    ${kv("Faktor", `${fmt(factor,2)}`)}
    ${kv("Notiz", note ? note : "—")}
  `;
  detailBox.style.display = "block";
}
function hideDetail(){
  document.getElementById("detailBox").style.display="none";
  document.getElementById("detailGrid").innerHTML="";
  document.getElementById("detailTitle").textContent="Details";
}

/* =========================
   Copy offer text
   ========================= */
async function copyOfferText(customer, row, inputs, routeKm){
  const {product, qtyT, freightPerKm, factor, targetVk} = inputs;
  const marginPerT = isFinite(targetVk) ? (targetVk - row.deliveredPerT) : NaN;
  const profitTotal = isFinite(marginPerT) ? (marginPerT * qtyT) : NaN;

  const zoneCust = (isFinite(customer.lat)&&isFinite(customer.lon)) ? getZoneNameForLatLng(customer.lat, customer.lon) : "";
  const zoneFirm = (isFinite(row.f.lat)&&isFinite(row.f.lon)) ? getZoneNameForLatLng(row.f.lat, row.f.lon) : "";

  const text =
`Angebots-Vorschlag
Kunde: ${customer.name}
Adresse: ${customer.address}
Zone: ${zoneCust || "-"}
Produkt: ${productLabel(product)}
Menge: ${qtyT} t

Firma: ${row.f.name}
Adresse: ${row.f.address}
Zone: ${zoneFirm || "-"}
Stand: ${row.f.stand || "—"}
Luftlinie: ${row.kmAir.toFixed(1)} km
Route: ${routeKm && isFinite(routeKm) ? routeKm.toFixed(1) : "—"} km

Basis: ${round2(row.base)} €/t
Fracht: ${round2(row.freightPerT)} €/t
Lieferpreis: ${round2(row.deliveredPerT)} €/t
Gesamt: ${round2(row.deliveredTotal)} € für ${qtyT} t

Ziel-VK: ${isFinite(targetVk) ? round2(targetVk) : "—"} €/t
Marge: ${isFinite(marginPerT) ? round2(marginPerT) : "—"} €/t
Gewinn gesamt: ${isFinite(profitTotal) ? round2(profitTotal) : "—"} €

Fracht €/km: ${freightPerKm} | Faktor: ${factor}`;

  try{
    await navigator.clipboard.writeText(text);
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value=text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
  }
}

/* =========================
   Panel drag + persist
   ========================= */
function initPanelDrag(){
  const panel = document.getElementById("panel");
  const header = document.getElementById("panelHeader");

  const pos = loadLS(LS_PANEL_POS_KEY, null);
  if(pos && isFinite(pos.x) && isFinite(pos.y)){
    panel.style.left = pos.x+"px";
    panel.style.top  = pos.y+"px";
    panel.style.right = "auto";
  }

  let dragging=false, sx=0, sy=0, sl=0, st=0;
  header.addEventListener("mousedown",(e)=>{
    dragging=true;
    const r = panel.getBoundingClientRect();
    sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top;
    panel.style.right="auto";
    e.preventDefault();
  });

  window.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    const x = Math.max(6, sl + (e.clientX-sx));
    const y = Math.max(6, st + (e.clientY-sy));
    panel.style.left = x+"px";
    panel.style.top  = y+"px";
  });

  window.addEventListener("mouseup",()=>{
    if(!dragging) return;
    dragging=false;
    const r = panel.getBoundingClientRect();
    saveLS(LS_PANEL_POS_KEY, {x:r.left, y:r.top});
  });
}

/* =========================
   KPI updates
   ========================= */
function updateCustomerKpi(c){
  if(!c){
    document.getElementById("kpiCustomer").textContent = "—";
    document.getElementById("kpiCustomerAddr").textContent = "—";
    document.getElementById("kpiCount").textContent = "—";
    document.getElementById("kpiRoute").textContent = "—";
    document.getElementById("kpiQty").textContent = "Menge: —";
    document.getElementById("ordersBox").style.display = "none";
    return;
  }
  const zoneName = (isFinite(c.lat)&&isFinite(c.lon)) ? getZoneNameForLatLng(c.lat, c.lon) : "";
  document.getElementById("kpiCustomer").textContent = c.name || "—";
  document.getElementById("kpiCustomerAddr").textContent = (c.address || "—") + (zoneName ? ` · Zone: ${zoneName}` : "");
  document.getElementById("kpiRoute").textContent = "—";
}

/* =========================
   Helpers
   ========================= */
function isYes(v){
  const s = String(v ?? "").trim().toLowerCase();
  return s === "ja" || s === "yes" || s === "y" || s === "1" || s === "true" || s === "ok";
}

function normText(s){
  return String(s||"")
    .trim()
    .toLowerCase()
    .replace(/\s+/g," ")
    .replace(/[.,;:_/\\|()\-–—]/g,"")
    .replace(/ä/g,"ae").replace(/ö/g,"oe").replace(/ü/g,"ue").replace(/ß/g,"ss");
}

function getStandFromRow(r){
  const direct = str(r["stand"]).trim();
  if(direct) return direct;

  if(Object.prototype.hasOwnProperty.call(r, "")){
    const v = str(r[""]).trim();
    if(v) return v;
  }

  if(Array.isArray(r["__parsed_extra"]) && r["__parsed_extra"].length){
    const v = str(r["__parsed_extra"][0]).trim();
    if(v) return v;
  }

  for(const k of Object.keys(r)){
    if(String(k).trim()===""){
      const v = str(r[k]).trim();
      if(v) return v;
    }
  }
  return "";
}

function toInt(v){
  const n = parseInt(String(v ?? "").trim(), 10);
  return Number.isFinite(n) ? n : 0;
}

function toNum(v){
  if(v===null || v===undefined) return NaN;
  if(typeof v==="number") return v;

  let s = String(v).trim();
  if(!s) return NaN;

  s = s.replace(/[€\s]/g, "");

  const hasComma = s.includes(",");
  const hasDot   = s.includes(".");

  if(hasComma && hasDot){
    s = s.replace(/\./g, "").replace(",", ".");
  }else if(hasComma && !hasDot){
    s = s.replace(",", ".");
  }else{
    s = s.replace(/,/g, "");
  }

  const n = parseFloat(s);
  return Number.isFinite(n) ? n : NaN;
}

function str(v){ return (v===null||v===undefined) ? "" : String(v); }
function fmt(n, dec=2){
  if(!isFinite(n)) return "—";
  return n.toFixed(dec).replace(".", ",");
}
function round2(n){ return Math.round(n*100)/100; }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function esc(s){
  return String(s).replace(/[&<>"']/g, m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function productLabel(p){
  if(p==="lose") return "Lose";
  if(p==="sackware") return "Sackware";
  if(p==="industrieware") return "Industrieware";
  return p;
}
function haversineKm(lat1, lon1, lat2, lon2){
  const R = 6371;
  const toRad = d => d * Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*(Math.sin(dLon/2)**2);
  return 2*R*Math.asin(Math.sqrt(a));
}
function saveLS(key, obj){
  try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
}
function loadLS(key, fallback){
  try{
    const s = localStorage.getItem(key);
    return s ? JSON.parse(s) : fallback;
  }catch(e){ return fallback; }
}
</script>
</body>
</html>
